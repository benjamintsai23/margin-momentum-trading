name: 策略回測

on:
  # 每週一凌晨 2:00 (UTC+8) 執行回測
  schedule:
    - cron: '0 18 * * 0'  # UTC 18:00 (周日) = 台灣時間 02:00 (周一)

  # 允許手動觸發
  workflow_dispatch:
    inputs:
      start_date:
        description: '回測開始日期 (YYYY-MM-DD)'
        required: true
        default: '2023-01-01'
      end_date:
        description: '回測結束日期 (YYYY-MM-DD)，空白表示昨日'
        required: false

jobs:
  backtest:
    runs-on: ubuntu-latest

    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4

      - name: 設定 Python 環境
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 安裝依賴
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 執行回測
        env:
          FINLAB_TOKEN: ${{ secrets.FINLAB_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
        run: |
          # 設定 credentials.json
          echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > credentials.json

          # 執行回測
          python main.py backtest \
            --start ${{ github.event.inputs.start_date || '2023-01-01' }} \
            --end ${{ github.event.inputs.end_date || '' }}

      - name: 回測成功通知
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ✅ 融資融券動能策略回測完成

            詳細結果請查看 Google Sheets

      - name: 回測失敗通知
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ❌ 融資融券動能策略回測失敗

            Repository: ${{ github.repository }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            請檢查日誌了解詳細原因。

      - name: 保存日誌
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: backtest-logs
          path: logs/
          retention-days: 30
